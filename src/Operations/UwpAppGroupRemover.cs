using Microsoft.Win32;
using Win10BloatRemover.UI;
using Win10BloatRemover.Utils;
using Env = System.Environment;

namespace Win10BloatRemover.Operations;

public enum UwpAppRemovalMode
{
    CurrentUser,
    AllUsers
}

public enum UwpAppGroup
{
    AlarmsAndClock,
    Bing,               // Weather, News, Finance and Sports
    Calculator,
    Camera,
    CommunicationsApps,
    Cortana,
    HelpAndFeedback,
    Maps,
    Messaging,
    MixedReality,       // 3D Viewer, Print 3D and Mixed Reality Portal
    Mobile,             // Your Phone and Mobile plans (aka OneConnect)
    OfficeHub,
    OneNote,
    Paint3D,
    Photos,
    Skype,
    SnipAndSketch,
    SolitaireCollection,
    SoundRecorder,
    StickyNotes,
    Store,
    Xbox,
    Zune                // Groove Music and Movies
}

public class UwpAppGroupRemover : IOperation
{
    private static readonly Dictionary<UwpAppGroup, string[]> appNamesForGroup = new() {
        { UwpAppGroup.AlarmsAndClock, new[] { "Microsoft.WindowsAlarms" } },
        { UwpAppGroup.Bing, new[] {
            "Microsoft.BingNews",
            "Microsoft.BingWeather",
            "Microsoft.BingFinance",
            "Microsoft.BingSports"
        } },
        { UwpAppGroup.Calculator, new[] { "Microsoft.WindowsCalculator" } },
        { UwpAppGroup.Camera, new[] { "Microsoft.WindowsCamera" } },
        { UwpAppGroup.CommunicationsApps, new[] { "microsoft.windowscommunicationsapps", "Microsoft.People" } },
        { UwpAppGroup.Cortana, new[] { "Microsoft.549981C3F5F10" } },
        { UwpAppGroup.HelpAndFeedback, new[] {
            "Microsoft.WindowsFeedbackHub",
            "Microsoft.GetHelp",
            "Microsoft.Getstarted"
        } },
        { UwpAppGroup.Maps, new[] { "Microsoft.WindowsMaps" } },
        { UwpAppGroup.Messaging, new[] { "Microsoft.Messaging" } },
        { UwpAppGroup.MixedReality, new[] {
            "Microsoft.Microsoft3DViewer",
            "Microsoft.Print3D",
            "Microsoft.MixedReality.Portal"
        } },
        { UwpAppGroup.Mobile, new[] { "Microsoft.YourPhone", "Microsoft.OneConnect" } },
        { UwpAppGroup.OfficeHub, new[] { "Microsoft.MicrosoftOfficeHub" } },
        { UwpAppGroup.OneNote, new[] { "Microsoft.Office.OneNote" } },
        { UwpAppGroup.Paint3D, new[] { "Microsoft.MSPaint" } },
        { UwpAppGroup.Photos, new[] { "Microsoft.Windows.Photos" } },
        { UwpAppGroup.Skype, new[] { "Microsoft.SkypeApp" } },
        { UwpAppGroup.SnipAndSketch, new[] { "Microsoft.ScreenSketch" } },
        { UwpAppGroup.SolitaireCollection, new[] { "Microsoft.MicrosoftSolitaireCollection" } },
        { UwpAppGroup.SoundRecorder, new[] { "Microsoft.WindowsSoundRecorder" } },
        { UwpAppGroup.StickyNotes, new[] { "Microsoft.MicrosoftStickyNotes" } },
        { UwpAppGroup.Store, new[] { "Microsoft.WindowsStore", "Microsoft.StorePurchaseApp" } },
        { UwpAppGroup.Xbox, new[] {
            "Microsoft.XboxGameCallableUI",
            "Microsoft.XboxSpeechToTextOverlay",
            "Microsoft.XboxApp",
            "Microsoft.XboxGameOverlay",
            "Microsoft.XboxGamingOverlay",
            "Microsoft.XboxIdentityProvider",
            "Microsoft.Xbox.TCUI"
        } },
        { UwpAppGroup.Zune, new[] { "Microsoft.ZuneMusic", "Microsoft.ZuneVideo" } }
    };

    private readonly Dictionary<UwpAppGroup, Action> postUninstallOperationsForGroup;
    private readonly UwpAppGroup[] appsToRemove;
    private readonly UwpAppRemovalMode removalMode;
    private readonly IUserInterface ui;
    private readonly AppxRemover appxRemover;
    private readonly ServiceRemover serviceRemover;

    private int totalRemovedApps = 0;

    private readonly RebootRecommendedFlag rebootFlag = new RebootRecommendedFlag();
    public bool IsRebootRecommended => rebootFlag.IsRebootRecommended;

    public UwpAppGroupRemover(UwpAppGroup[] appsToRemove, UwpAppRemovalMode removalMode, IUserInterface ui,
                              AppxRemover appxRemover, ServiceRemover serviceRemover)
    {
        this.appsToRemove = appsToRemove;
        this.removalMode = removalMode;
        this.ui = ui;
        this.appxRemover = appxRemover;
        this.serviceRemover = serviceRemover;

        postUninstallOperationsForGroup = new Dictionary<UwpAppGroup, Action> {
            { UwpAppGroup.CommunicationsApps, RemoveOneSyncServiceFeature },
            { UwpAppGroup.Cortana, HideCortanaFromTaskBar },
            { UwpAppGroup.Maps, RemoveMapsServicesAndTasks },
            { UwpAppGroup.Messaging, RemoveMessagingService },
            { UwpAppGroup.Paint3D, RemovePaint3DContextMenuEntries },
            { UwpAppGroup.Photos, RestoreWindowsPhotoViewer },
            { UwpAppGroup.MixedReality, RemoveMixedRealityAppsLeftovers },
            { UwpAppGroup.Xbox, RemoveXboxServicesAndTasks },
            { UwpAppGroup.Store, DisableStoreFeaturesAndServices }
        };
    }

    public void Run()
    {
        foreach (UwpAppGroup appGroup in appsToRemove)
            UninstallAppsOfGroup(appGroup);

        if (totalRemovedApps > 0)
            RestartExplorer();
    }

    private void UninstallAppsOfGroup(UwpAppGroup appGroup)
    {
        string[] appsInGroup = appNamesForGroup[appGroup];
        ui.PrintHeading($"Removing {appGroup} {(appsInGroup.Length == 1 ? "app" : "apps")}...");

        (int removedApps, int failedRemovals) = removalMode == UwpAppRemovalMode.CurrentUser
            ? appxRemover.RemoveAppsForCurrentUser(appsInGroup)
            : appxRemover.RemoveAppsForAllUsers(appsInGroup);

        totalRemovedApps += removedApps;

        if (removalMode == UwpAppRemovalMode.AllUsers && failedRemovals == 0)
            TryPerformPostUninstallOperations(appGroup);
    }

    private void RestartExplorer()
    {
        ui.PrintHeading("Restarting Explorer to avoid stale app entries in Start menu...");
        OS.CloseExplorer();
        OS.StartExplorer();
    }

    private void TryPerformPostUninstallOperations(UwpAppGroup appGroup)
    {
        try
        {
            if (postUninstallOperationsForGroup.ContainsKey(appGroup))
            {
                ui.PrintEmptySpace();
                postUninstallOperationsForGroup[appGroup]();
            }
        }
        catch (Exception exc)
        {
            ui.PrintError($"An error occurred while performing post-uninstall/cleanup operations: {exc.Message}");
        }
    }

    private void HideCortanaFromTaskBar()
    {
        ui.PrintMessage("Hiding Cortana from the taskbar of current and default user...");
        RegistryUtils.SetForCurrentAndDefaultUser(@"SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced", "ShowCortanaButton", 0);
    }

    private void RemoveMapsServicesAndTasks()
    {
        DisableScheduledTasks(@"\Microsoft\Windows\Maps\MapsUpdateTask", @"\Microsoft\Windows\Maps\MapsToastTask");
        RemoveServices("MapsBroker", "lfsvc");
    }

    private void RemoveXboxServicesAndTasks()
    {
        DisableScheduledTasks(@"Microsoft\XblGameSave\XblGameSaveTask");
        RemoveServices("XblAuthManager", "XblGameSave", "XboxNetApiSvc", "XboxGipSvc");

        ui.PrintMessage("Disabling Xbox Game Bar...");
        Registry.SetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\GameDVR", "AllowGameDVR", 0);
        rebootFlag.SetRecommended();
    }

    private void RemoveMessagingService()
    {
        RemoveServices("MessagingService");
    }

    private void RemovePaint3DContextMenuEntries()
    {
        ui.PrintMessage("Removing Paint 3D context menu entries...");
        OS.ExecuteWindowsPromptCommand(
            @"for /f ""tokens=1* delims="" %I in " +
             @"(' reg query ""HKEY_CLASSES_ROOT\SystemFileAssociations"" /s /k /f ""3D Edit"" ^| find /i ""3D Edit"" ') " +
            @"do (reg delete ""%I"" /f > nul)",
            ui
        );
    }

    private void RemoveMixedRealityAppsLeftovers()
    {
        Remove3DObjectsFolder();
        Remove3DPrintContextMenuEntries();
    }

    private void Remove3DObjectsFolder()
    {
        ui.PrintMessage("Removing 3D Objects folder...");
        using RegistryKey key = RegistryUtils.LocalMachine64.OpenSubKeyWritable(
            @"SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\MyComputer\NameSpace"
        );
        key.DeleteSubKeyTree("{0DB7E03F-FC29-4DC6-9020-FF41B59E513A}", throwOnMissingSubKey: false);

        OS.TryDeleteDirectoryIfExists($@"{Env.GetFolderPath(Env.SpecialFolder.UserProfile)}\3D Objects", ui);
    }

    private void Remove3DPrintContextMenuEntries()
    {
        ui.PrintMessage("Removing 3D Print context menu entries...");
        OS.ExecuteWindowsPromptCommand(
            @"for /f ""tokens=1* delims="" %I in " +
            @"(' reg query ""HKEY_CLASSES_ROOT\SystemFileAssociations"" /s /k /f ""3D Print"" ^| find /i ""3D Print"" ') " +
            @"do (reg delete ""%I"" /f > nul)",
            ui
        );
    }

    private void RestoreWindowsPhotoViewer()
    {
        ui.PrintMessage("Setting file association with legacy photo viewer for BMP, GIF, JPEG, PNG and TIFF pictures...");

        const string PHOTO_VIEWER_SHELL_COMMAND =
            @"%SystemRoot%\System32\rundll32.exe ""%ProgramFiles%\Windows Photo Viewer\PhotoViewer.dll"", ImageView_Fullscreen %1";
        const string PHOTO_VIEWER_CLSID = "{FFE2A43C-56B9-4bf5-9A79-CC6D4285608A}";

        Registry.SetValue(@"HKEY_CLASSES_ROOT\Applications\photoviewer.dll\shell\open", "MuiVerb", "@photoviewer.dll,-3043");
        Registry.SetValue(
            @"HKEY_CLASSES_ROOT\Applications\photoviewer.dll\shell\open\command", valueName: null,
            PHOTO_VIEWER_SHELL_COMMAND, RegistryValueKind.ExpandString
        );
        Registry.SetValue(@"HKEY_CLASSES_ROOT\Applications\photoviewer.dll\shell\open\DropTarget", "Clsid", PHOTO_VIEWER_CLSID);

        string[] imageTypes = ["Paint.Picture", "giffile", "jpegfile", "pngfile"];
        foreach (string type in imageTypes)
        {
            Registry.SetValue(
                $@"HKEY_CLASSES_ROOT\{type}\shell\open\command", valueName: null,
                PHOTO_VIEWER_SHELL_COMMAND, RegistryValueKind.ExpandString
            );
            Registry.SetValue($@"HKEY_CLASSES_ROOT\{type}\shell\open\DropTarget", "Clsid", PHOTO_VIEWER_CLSID);
        }
    }

    private void RemoveOneSyncServiceFeature()
    {
        var featuresRemover = new FeaturesRemover(["OneCoreUAP.OneSync"], ui);
        featuresRemover.Run();
        rebootFlag.UpdateIfNeeded(featuresRemover.IsRebootRecommended);
    }

    private void DisableStoreFeaturesAndServices()
    {
        ui.PrintMessage("Disabling Microsoft Store features...");
        Registry.SetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\WindowsStore", "RemoveWindowsStore", 1);
        Registry.SetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\PushToInstall", "DisablePushToInstall", 1);
        RegistryUtils.SetForCurrentAndDefaultUser(
            @"SOFTWARE\Microsoft\Windows\CurrentVersion\ContentDeliveryManager",
            "SilentInstalledAppsEnabled", 0
        );
        rebootFlag.SetRecommended();

        RemoveServices("PushToInstall");
    }

    private void DisableScheduledTasks(params string[] scheduledTasks)
    {
        new ScheduledTasksDisabler(scheduledTasks, ui).Run();
    }

    private void RemoveServices(params string[] services)
    {
        serviceRemover.BackupAndRemove(services);
        rebootFlag.UpdateIfNeeded(serviceRemover.IsRebootRecommended);
    }
}
